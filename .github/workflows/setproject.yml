name: Auto set Project field (detect by existing issues)

on:
  issues:
    types: [opened]

permissions:
  issues: write
  repository-projects: write

jobs:
  update-project:
    runs-on: ubuntu-latest
    steps:
      - name: Detect project dynamically
        uses: actions/github-script@v7
        with:
          script: |

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issueNodeId = context.payload.issue.node_id;

            // 1️⃣ Obtener Projects v2 del usuario
            const userData = await github.graphql(`
              query {
                user(login: "${owner}") {
                  projectsV2(first: 20) {
                    nodes {
                      id
                      title
                      items(first: 50) {
                        nodes {
                          content {
                            __typename
                            ... on Issue {
                              repository {
                                name
                              }
                            }
                          }
                        }
                      }
                      fields(first: 50) {
                        nodes {
                          ... on ProjectV2FieldCommon {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            `);

            const projects = userData.user.projectsV2.nodes;

            let selectedProject = null;
            let fieldId = null;

            for (const project of projects) {

              const hasIssueFromRepo = project.items.nodes.some(item =>
                item.content &&
                item.content.__typename === "Issue" &&
                item.content.repository.name === repo
              );

              if (hasIssueFromRepo) {
                selectedProject = project;
                const field = project.fields.nodes.find(f => f.name === "Project");
                if (field) {
                  fieldId = field.id;
                }
                break;
              }
            }

            if (!selectedProject) {
              core.setFailed("No Project v2 found containing issues from this repo.");
              return;
            }

            if (!fieldId) {
              core.setFailed('Field "Project" not found.');
              return;
            }

            const projectId = selectedProject.id;
            const projectName = selectedProject.title;

            // 2️⃣ Añadir issue al project
            const addItem = await github.graphql(`
              mutation {
                addProjectV2ItemById(input: {
                  projectId: "${projectId}",
                  contentId: "${issueNodeId}"
                }) {
                  item {
                    id
                  }
                }
              }
            `);

            const itemId = addItem.addProjectV2ItemById.item.id;

            // 3️⃣ Actualizar campo Text
            await github.graphql(`
              mutation {
                updateProjectV2ItemFieldValue(input: {
                  projectId: "${projectId}",
                  itemId: "${itemId}",
                  fieldId: "${fieldId}",
                  value: {
                    text: "${projectName}"
                  }
                }) {
                  projectV2Item {
                    id
                  }
                }
              }
            `);

            console.log(`Field updated with project name: ${projectName}`);
