name: Auto set Project field (linked project)

on:
  issues:
    types: [opened]

permissions:
  issues: write
  repository-projects: write

jobs:
  update-project:
    runs-on: ubuntu-latest
    steps:
      - name: Detect linked project and update field
        uses: actions/github-script@v7
        with:
          script: |

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issueNodeId = context.payload.issue.node_id;

            // 1️⃣ Obtener Projects vinculados al repo
            const repoData = await github.graphql(`
              query {
                repository(owner: "${owner}", name: "${repo}") {
                  projects(first: 10) {
                    nodes {
                      id
                      title
                      fields(first: 50) {
                        nodes {
                          ... on ProjectFieldCommon {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            `);

            const projects = repoData.repository.projectsV2.nodes;

            if (!projects.length) {
              core.setFailed("This repository is not linked to any Project v2.");
              return;
            }

            // Tomamos el primer project vinculado
            const selectedProject = projects[0];

            const field = selectedProject.fields.nodes.find(f => f.name === "Project");

            if (!field) {
              core.setFailed('Field "Project" not found in linked project.');
              return;
            }

            const projectId = selectedProject.id;
            const projectName = selectedProject.title;
            const projectFieldId = field.id;

            // 2️⃣ Añadir issue al project
            const addItem = await github.graphql(`
              mutation {
                addProjectV2ItemById(input: {
                  projectId: "${projectId}",
                  contentId: "${issueNodeId}"
                }) {
                  item {
                    id
                  }
                }
              }
            `);

            const itemId = addItem.addProjectV2ItemById.item.id;

            // 3️⃣ Actualizar campo tipo Text
            await github.graphql(`
              mutation {
                updateProjectV2ItemFieldValue(input: {
                  projectId: "${projectId}",
                  itemId: "${itemId}",
                  fieldId: "${projectFieldId}",
                  value: {
                    text: "${projectName}"
                  }
                }) {
                  projectV2Item {
                    id
                  }
                }
              }
            `);

            console.log(`Issue linked to project "${projectName}" and field updated.`);
