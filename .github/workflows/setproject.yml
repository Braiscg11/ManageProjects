name: Auto set Project field (stable)

on:
  issues:
    types: [opened]

permissions:
  issues: write
  repository-projects: write

jobs:
  update-project:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |

            const projectId = process.env.PROJECT_V2_ID;
            const issueNodeId = context.payload.issue.node_id;

            // Obtener fields del project
            const projectData = await github.graphql(`
              query {
                node(id: "${projectId}") {
                  ... on ProjectV2 {
                    title
                    fields(first: 50) {
                      nodes {
                        ... on ProjectV2FieldCommon {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            `);

            const project = projectData.node;
            const field = project.fields.nodes.find(f => f.name === "Project");

            if (!field) {
              core.setFailed('Field "Project" not found.');
              return;
            }

            const projectName = project.title;
            const fieldId = field.id;

            // AÃ±adir issue
            const addItem = await github.graphql(`
              mutation {
                addProjectV2ItemById(input: {
                  projectId: "${projectId}",
                  contentId: "${issueNodeId}"
                }) {
                  item { id }
                }
              }
            `);

            const itemId = addItem.addProjectV2ItemById.item.id;

            // Actualizar campo
            await github.graphql(`
              mutation {
                updateProjectV2ItemFieldValue(input: {
                  projectId: "${projectId}",
                  itemId: "${itemId}",
                  fieldId: "${fieldId}",
                  value: { text: "${projectName}" }
                }) {
                  projectV2Item { id }
                }
              }
            `);
        env:
          PROJECT_V2_ID: ${{ secrets.PROJECT_V2_ID }}
