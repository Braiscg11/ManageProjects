name: Auto set Project field (linked project only)

on:
  issues:
    types: [opened]

permissions:
  issues: write
  repository-projects: write

jobs:
  update-project:
    runs-on: ubuntu-latest
    steps:
      - name: Detect linked project and update field
        uses: actions/github-script@v7
        with:
          script: |

            const org = context.repo.owner;
            const repoNodeId = context.payload.repository.node_id;
            const issueNodeId = context.payload.issue.node_id;

            // 1️⃣ Obtener projects de la organización
            const projectsData = await github.graphql(`
              query {
                organization(login: "${org}") {
                  projectsV2(first: 20) {
                    nodes {
                      id
                      title
                      items(first: 20) {
                        nodes {
                          content {
                            __typename
                            ... on Repository {
                              id
                            }
                          }
                        }
                      }
                      fields(first: 50) {
                        nodes {
                          ... on ProjectV2FieldCommon {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            `);

            const projects = projectsData.organization.projectsV2.nodes;

            let selectedProject = null;
            let projectFieldId = null;

            for (const project of projects) {

              // ¿El project contiene este repo?
              const containsRepo = project.items.nodes.some(item =>
                item.content &&
                item.content.__typename === "Repository" &&
                item.content.id === repoNodeId
              );

              if (containsRepo) {
                selectedProject = project;

                const field = project.fields.nodes.find(f => f.name === "Project");
                if (field) {
                  projectFieldId = field.id;
                }

                break;
              }
            }

            if (!selectedProject) {
              core.setFailed("No linked Project v2 found for this repository.");
              return;
            }

            if (!projectFieldId) {
              core.setFailed('Field "Project" not found in linked project.');
              return;
            }

            const projectId = selectedProject.id;
            const projectName = selectedProject.title;

            // 2️⃣ Añadir issue al project
            const addItem = await github.graphql(`
              mutation {
                addProjectV2ItemById(input: {
                  projectId: "${projectId}",
                  contentId: "${issueNodeId}"
                }) {
                  item {
                    id
                  }
                }
              }
            `);

            const itemId = addItem.addProjectV2ItemById.item.id;

            // 3️⃣ Rellenar campo tipo Text
            await github.graphql(`
              mutation {
                updateProjectV2ItemFieldValue(input: {
                  projectId: "${projectId}",
                  itemId: "${itemId}",
                  fieldId: "${projectFieldId}",
                  value: {
                    text: "${projectName}"
                  }
                }) {
                  projectV2Item {
                    id
                  }
                }
              }
            `);

            console.log(`Issue linked to project "${projectName}" and field updated.`);
